# .github/workflows/pr-validation.yml
# Workflow para validaÃ§Ã£o de Pull Requests
# Projeto: DevOps UNISATC A3 - Strapi Application

name: ğŸ” PR Validation

on:
  pull_request:
    branches: [ master, main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # Job para anÃ¡lise estÃ¡tica do cÃ³digo
  code-analysis:
    name: ğŸ“Š Code Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Lint check
        run: |
          # Se existir ESLint configurado
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo "ğŸ” Executando ESLint..."
            pnpm exec eslint . --ext .js,.ts,.jsx,.tsx --max-warnings 0
          else
            echo "â„¹ï¸ ESLint nÃ£o configurado, usando verificaÃ§Ã£o bÃ¡sica..."
            # VerificaÃ§Ã£o bÃ¡sica de sintaxe JavaScript
            find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
          fi

      - name: ğŸ¨ Format check
        run: |
          # Se existir Prettier configurado
          if [ -f ".prettierrc" ] || [ -f ".prettierrc.js" ] || [ -f ".prettierrc.json" ]; then
            echo "ğŸ¨ Verificando formataÃ§Ã£o com Prettier..."
            pnpm exec prettier --check "**/*.{js,ts,jsx,tsx,json,md,yml,yaml}"
          else
            echo "â„¹ï¸ Prettier nÃ£o configurado, pulando verificaÃ§Ã£o de formataÃ§Ã£o"
          fi

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ”’ Executando auditoria de seguranÃ§a..."
          pnpm audit --audit-level moderate
        continue-on-error: true

      - name: ğŸ“‹ Package.json validation
        run: |
          echo "ğŸ“‹ Validando package.json..."
          node -e "
            const pkg = require('./package.json');
            if (!pkg.name) throw new Error('package.json deve ter um nome');
            if (!pkg.version) throw new Error('package.json deve ter uma versÃ£o');
            if (!pkg.scripts) throw new Error('package.json deve ter scripts');
            console.log('âœ… package.json vÃ¡lido');
          "

  # Job para build e teste da aplicaÃ§Ã£o
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: code-analysis
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: strapi_test
          POSTGRES_USER: strapi
          POSTGRES_PASSWORD: strapi_test_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build application
        run: |
          echo "ğŸ—ï¸ Building Strapi application..."
          pnpm build
        env:
          NODE_ENV: production
          DATABASE_CLIENT: postgres
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_NAME: strapi_test
          DATABASE_USERNAME: strapi
          DATABASE_PASSWORD: strapi_test_pass
          JWT_SECRET: test_jwt_secret_for_pr_validation
          ADMIN_JWT_SECRET: test_admin_jwt_secret_for_pr_validation
          APP_KEYS: test_app_key_1,test_app_key_2,test_app_key_3,test_app_key_4
          API_TOKEN_SALT: test_api_token_salt
          TRANSFER_TOKEN_SALT: test_transfer_token_salt

      - name: ğŸ§ª Run unit tests (if available)
        run: |
          if [ -f "package.json" ] && pnpm run --if-present test:unit; then
            echo "âœ… Unit tests executados"
          else
            echo "â„¹ï¸ Nenhum teste unitÃ¡rio encontrado"
          fi
        continue-on-error: true

      - name: ğŸš€ Start Strapi for testing
        run: |
          echo "ğŸš€ Iniciando Strapi em background..."
          pnpm start &
          echo $! > strapi.pid
          
          # Aguarda Strapi estar pronto
          echo "â³ Aguardando Strapi estar pronto..."
          timeout 120s bash -c 'until curl -f http://localhost:1337/_health; do sleep 2; done'
          echo "âœ… Strapi estÃ¡ rodando"
        env:
          NODE_ENV: development
          DATABASE_CLIENT: postgres
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_NAME: strapi_test
          DATABASE_USERNAME: strapi
          DATABASE_PASSWORD: strapi_test_pass
          JWT_SECRET: test_jwt_secret_for_pr_validation
          ADMIN_JWT_SECRET: test_admin_jwt_secret_for_pr_validation
          APP_KEYS: test_app_key_1,test_app_key_2,test_app_key_3,test_app_key_4
          API_TOKEN_SALT: test_api_token_salt
          TRANSFER_TOKEN_SALT: test_transfer_token_salt

      - name: ğŸ” Health check
        run: |
          echo "ğŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
          
          # Verifica health endpoint
          health_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:1337/_health)
          if [ "$health_status" -eq 204 ]; then
            echo "âœ… Health check passou (204)"
          else
            echo "âŒ Health check falhou (${health_status})"
            exit 1
          fi
          
          # Verifica API bÃ¡sica
          api_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:1337/api)
          if [ "$api_status" -eq 200 ]; then
            echo "âœ… API estÃ¡ respondendo (200)"
          else
            echo "âŒ API nÃ£o estÃ¡ respondendo (${api_status})"
            exit 1
          fi

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: strapi-build-pr-${{ github.event.number }}
          path: |
            build/
            dist/
          retention-days: 7

  # Job para testes E2E (versÃ£o simplificada para PR)
  e2e-tests:
    name: ğŸ­ E2E Tests (Smoke)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-e2e-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Install Playwright
        run: pnpm exec playwright install --with-deps chromium

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: strapi-build-pr-${{ github.event.number }}

      - name: ğŸš€ Start Strapi for E2E
        run: |
          pnpm start &
          echo $! > strapi.pid
          timeout 120s bash -c 'until curl -f http://localhost:1337/_health; do sleep 2; done'
        env:
          NODE_ENV: test
          DATABASE_CLIENT: sqlite
          DATABASE_FILENAME: .tmp/test-data.db
          JWT_SECRET: test_jwt_secret_for_e2e
          ADMIN_JWT_SECRET: test_admin_jwt_secret_for_e2e
          APP_KEYS: test_app_key_1,test_app_key_2,test_app_key_3,test_app_key_4
          API_TOKEN_SALT: test_api_token_salt
          TRANSFER_TOKEN_SALT: test_transfer_token_salt

      - name: ğŸ§ª Run smoke tests
        run: |
          # Executa apenas testes essenciais para PR
          pnpm test --grep="@smoke" --project=chromium
        env:
          CI: true
          STRAPI_URL: http://localhost:1337

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results-pr-${{ github.event.number }}
          path: |
            test-results/
            playwright-report/

  # Job para verificaÃ§Ã£o de seguranÃ§a
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: code-analysis
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Job para verificar mudanÃ§as no Docker
  docker-check:
    name: ğŸ³ Docker Check
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'Dockerfile') || contains(github.event.pull_request.changed_files, 'docker-compose')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Validate Dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "ğŸ” Validando Dockerfile..."
            docker run --rm -i hadolint/hadolint < Dockerfile
          fi

      - name: ğŸ§ª Test Docker build
        run: |
          if [ -f "Dockerfile" ]; then
            echo "ğŸ—ï¸ Testando build do Docker..."
            docker build -t strapi-test:pr-${{ github.event.number }} .
            echo "âœ… Docker build successful"
          fi

  # Job de consolidaÃ§Ã£o dos resultados
  pr-status:
    name: ğŸ“‹ PR Status Summary
    runs-on: ubuntu-latest
    needs: [code-analysis, build-and-test, e2e-tests, security-scan]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate PR summary
        run: |
          echo "# ğŸ“‹ Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ” Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Analysis
          if [ "${{ needs.code-analysis.result }}" = "success" ]; then
            echo "âœ… **Code Analysis**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Analysis**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build & Test
          if [ "${{ needs.build-and-test.result }}" = "success" ]; then
            echo "âœ… **Build & Test**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build & Test**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # E2E Tests
          if [ "${{ needs.e2e-tests.result }}" = "success" ]; then
            echo "âœ… **E2E Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **E2E Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Security Scan
          if [ "${{ needs.security-scan.result }}" = "success" ]; then
            echo "âœ… **Security Scan**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security Scan**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Details" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.event.pull_request.head.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ¤– PR Validation Results')
            );

            const results = {
              codeAnalysis: '${{ needs.code-analysis.result }}',
              buildTest: '${{ needs.build-and-test.result }}',
              e2eTests: '${{ needs.e2e-tests.result }}',
              securityScan: '${{ needs.security-scan.result }}'
            };

            const getIcon = (result) => result === 'success' ? 'âœ…' : 'âŒ';
            
            const body = `## ğŸ¤– PR Validation Results

            | Check | Status | Result |
            |-------|--------|--------|
            | Code Analysis | ${getIcon(results.codeAnalysis)} | ${results.codeAnalysis.toUpperCase()} |
            | Build & Test | ${getIcon(results.buildTest)} | ${results.buildTest.toUpperCase()} |
            | E2E Tests | ${getIcon(results.e2eTests)} | ${results.e2eTests.toUpperCase()} |
            | Security Scan | ${getIcon(results.securityScan)} | ${results.securityScan.toUpperCase()} |

            **Overall Status**: ${Object.values(results).every(r => r === 'success') ? 'âœ… ALL CHECKS PASSED' : 'âŒ SOME CHECKS FAILED'}

            ---
            *Last updated: ${new Date().toISOString()}*
            *Workflow: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: âŒ Fail if any check failed
        if: needs.code-analysis.result != 'success' || needs.build-and-test.result != 'success' || needs.e2e-tests.result != 'success' || needs.security-scan.result != 'success'
        run: |
          echo "âŒ Um ou mais checks falharam. PR nÃ£o pode ser merged."
          exit 1

      - name: âœ… All checks passed
        if: needs.code-analysis.result == 'success' && needs.build-and-test.result == 'success' && needs.e2e-tests.result == 'success' && needs.security-scan.result == 'success'
        run: |
          echo "âœ… Todos os checks passaram! PR estÃ¡ pronto para merge."