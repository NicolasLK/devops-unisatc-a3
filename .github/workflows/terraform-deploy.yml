# .github/workflows/terraform-deploy.yml
# Workflow para deploy automatizado usando Terraform no Google Cloud Platform
# Projeto: DevOps UNISATC A3 - Strapi Application

name: ğŸš€ Terraform Deploy

on:
  push:
    branches: [ master, main ]
    paths: 
      - 'terraform/**'
      - '.github/workflows/terraform-deploy.yml'
  pull_request:
    branches: [ master, main ]
    paths: 
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      auto_approve:
        description: 'Auto approve (use with caution)'
        type: boolean
        default: false

env:
  TF_VERSION: '1.5.7'
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: 'us-central1'
  GCP_ZONE: 'us-central1-a'

jobs:
  # Job para validaÃ§Ã£o do Terraform
  terraform-validate:
    name: ğŸ” Terraform Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ” Terraform Format Check
        working-directory: ./terraform
        run: |
          echo "ğŸ¨ Checking Terraform formatting..."
          terraform fmt -check -recursive
          if [ $? -ne 0 ]; then
            echo "âŒ Terraform files are not properly formatted"
            echo "ğŸ’¡ Run 'terraform fmt -recursive' to fix formatting"
            exit 1
          fi
          echo "âœ… Terraform formatting is correct"

      - name: ğŸ”§ Terraform Init
        working-directory: ./terraform
        run: |
          echo "ğŸ”§ Initializing Terraform..."
          terraform init -backend=false
        env:
          TF_IN_AUTOMATION: true

      - name: âœ… Terraform Validate
        working-directory: ./terraform
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate
          echo "âœ… Terraform configuration is valid"

      - name: ğŸ”’ Security scan with tfsec
        run: |
          echo "ğŸ”’ Running security scan with tfsec..."
          
          # Instala tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          
          # Executa scan
          tfsec ./terraform --format json --out tfsec-results.json || true
          
          # Mostra resultados
          if [ -f "tfsec-results.json" ]; then
            echo "ğŸ“Š Security scan results:"
            cat tfsec-results.json | jq '.results[] | select(.severity == "HIGH" or .severity == "CRITICAL")' || true
          fi
        continue-on-error: true

  # Job para plan do Terraform
  terraform-plan:
    name: ğŸ“‹ Terraform Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    strategy:
      matrix:
        environment: 
          - ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    
    env:
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_region: ${{ env.GCP_REGION }}
      TF_VAR_zone: ${{ env.GCP_ZONE }}
      TF_VAR_environment: ${{ matrix.environment }}
      TF_VAR_image_tag: ${{ github.sha }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ”§ Terraform Init
        working-directory: ./terraform
        run: |
          echo "ğŸ”§ Initializing Terraform for ${{ matrix.environment }}..."
          
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_TF_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state/${{ matrix.environment }}"
        env:
          TF_IN_AUTOMATION: true

      - name: ğŸ—ï¸ Select or Create Workspace
        working-directory: ./terraform
        run: |
          echo "ğŸ—ï¸ Managing Terraform workspace for ${{ matrix.environment }}..."
          
          # Lista workspaces existentes
          terraform workspace list
          
          # Seleciona ou cria workspace
          if terraform workspace select ${{ matrix.environment }} 2>/dev/null; then
            echo "âœ… Workspace ${{ matrix.environment }} selected"
          else
            echo "ğŸ†• Creating new workspace ${{ matrix.environment }}"
            terraform workspace new ${{ matrix.environment }}
          fi

      - name: ğŸ“‹ Terraform Plan
        working-directory: ./terraform
        run: |
          echo "ğŸ“‹ Creating Terraform plan for ${{ matrix.environment }}..."
          
          terraform plan \
            -var-file="environments/${{ matrix.environment }}.tfvars" \
            -out=tfplan-${{ matrix.environment }} \
            -detailed-exitcode
          
          PLAN_EXIT_CODE=$?
          
          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "â„¹ï¸ No changes detected"
            echo "terraform-changes=false" >> $GITHUB_OUTPUT
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "ğŸ“ Changes detected"
            echo "terraform-changes=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Terraform plan failed"
            exit 1
          fi
        id: plan

      - name: ğŸ“Š Generate Plan Summary
        working-directory: ./terraform
        run: |
          echo "ğŸ“Š Generating plan summary..."
          
          # Mostra resumo do plano
          terraform show -no-color tfplan-${{ matrix.environment }} > plan-output.txt
          
          # Adiciona ao summary do GitHub
          echo "## ğŸ“‹ Terraform Plan Summary - ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ğŸ“ Plan Details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`terraform" >> $GITHUB_STEP_SUMMARY
          head -100 plan-output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¤ Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: |
            terraform/tfplan-${{ matrix.environment }}
            terraform/plan-output.txt
          retention-days: 30

      - name: ğŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('terraform/plan-output.txt', 'utf8');
            const truncatedPlan = planOutput.length > 60000 ? 
              planOutput.slice(0, 60000) + '\n\n... (truncated)' : 
              planOutput;
            
            const body = `## ğŸ“‹ Terraform Plan - ${{ matrix.environment }}
            
            <details>
            <summary>ğŸ“ Click to see plan details</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            </details>
            
            **Changes detected**: ${{ steps.plan.outputs.terraform-changes }}
            **Environment**: ${{ matrix.environment }}
            **Commit**: ${{ github.sha }}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Job para apply do Terraform
  terraform-apply:
    name: ğŸš€ Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-validate, terraform-plan]
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    
    environment: 
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    
    env:
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_region: ${{ env.GCP_REGION }}
      TF_VAR_zone: ${{ env.GCP_ZONE }}
      TF_VAR_environment: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
      TF_VAR_image_tag: ${{ github.sha }}
      ENVIRONMENT: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ“¥ Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ env.ENVIRONMENT }}
          path: terraform/

      - name: ğŸ”§ Terraform Init
        working-directory: ./terraform
        run: |
          echo "ğŸ”§ Initializing Terraform for apply..."
          
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_TF_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state/${{ env.ENVIRONMENT }}"
        env:
          TF_IN_AUTOMATION: true

      - name: ğŸ—ï¸ Select Workspace
        working-directory: ./terraform
        run: |
          echo "ğŸ—ï¸ Selecting workspace ${{ env.ENVIRONMENT }}..."
          terraform workspace select ${{ env.ENVIRONMENT }}

      - name: ğŸš€ Terraform Apply
        working-directory: ./terraform
        run: |
          echo "ğŸš€ Applying Terraform changes for ${{ env.ENVIRONMENT }}..."
          
          if [ "${{ github.event.inputs.auto_approve }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
            terraform apply tfplan-${{ env.ENVIRONMENT }}
          else
            echo "âŒ Manual approval required for apply"
            exit 1
          fi
          
          echo "âœ… Terraform apply completed successfully"

      - name: ğŸ“Š Get Deployment Info
        working-directory: ./terraform
        run: |
          echo "ğŸ“Š Getting deployment information..."
          
          # ObtÃ©m outputs do Terraform
          terraform output -json > outputs.json
          
          echo "## ğŸš€ Deployment Summary - ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extrai informaÃ§Ãµes relevantes dos outputs
          if [ -f "outputs.json" ]; then
            APPLICATION_URL=$(cat outputs.json | jq -r '.application_url.value // "N/A"')
            LOAD_BALANCER_IP=$(cat outputs.json | jq -r '.load_balancer_ip.value // "N/A"')
            DATABASE_INSTANCE=$(cat outputs.json | jq -r '.database_instance.value // "N/A"')
            
            echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Environment** | ${{ env.ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Application URL** | ${APPLICATION_URL} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Load Balancer IP** | ${LOAD_BALANCER_IP} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Database** | ${DATABASE_INSTANCE} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Tag** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Deployed At** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ” Health Check
        run: |
          echo "ğŸ” Performing health check..."
          
          # ObtÃ©m URL da aplicaÃ§Ã£o
          APPLICATION_URL=$(cd terraform && terraform output -raw application_url 2>/dev/null || echo "")
          
          if [ -n "$APPLICATION_URL" ]; then
            echo "ğŸŒ Testing application at: $APPLICATION_URL"
            
            # Aguarda aplicaÃ§Ã£o estar disponÃ­vel
            for i in {1..30}; do
              if curl -f "$APPLICATION_URL/_health" >/dev/null 2>&1; then
                echo "âœ… Application is healthy!"
                break
              fi
              
              if [ $i -eq 30 ]; then
                echo "âš ï¸ Health check timeout - application may still be starting"
              else
                echo "â³ Waiting for application to be ready... (attempt $i/30)"
                sleep 10
              fi
            done
          else
            echo "â„¹ï¸ Application URL not available, skipping health check"
          fi

  # Job para destroy (apenas manual)
  terraform-destroy:
    name: ğŸ—‘ï¸ Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
    
    env:
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
      TF_VAR_region: ${{ env.GCP_REGION }}
      TF_VAR_zone: ${{ env.GCP_ZONE }}
      TF_VAR_environment: ${{ github.event.inputs.environment }}
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ› ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ”§ Terraform Init
        working-directory: ./terraform
        run: |
          echo "ğŸ”§ Initializing Terraform for destroy..."
          
          terraform init \
            -backend-config="bucket=${{ secrets.GCP_TF_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state/${{ env.ENVIRONMENT }}"
        env:
          TF_IN_AUTOMATION: true

      - name: ğŸ—ï¸ Select Workspace
        working-directory: ./terraform
        run: |
          echo "ğŸ—ï¸ Selecting workspace ${{ env.ENVIRONMENT }}..."
          terraform workspace select ${{ env.ENVIRONMENT }}

      - name: ğŸ“‹ Terraform Destroy Plan
        working-directory: ./terraform
        run: |
          echo "ğŸ“‹ Creating destroy plan..."
          
          terraform plan -destroy \
            -var-file="environments/${{ env.ENVIRONMENT }}.tfvars" \
            -out=destroy-plan

      - name: ğŸ—‘ï¸ Terraform Destroy
        working-directory: ./terraform
        if: github.event.inputs.auto_approve == 'true'
        run: |
          echo "ğŸ—‘ï¸ Destroying infrastructure for ${{ env.ENVIRONMENT }}..."
          echo "âš ï¸ This action will delete all resources!"
          
          terraform apply destroy-plan
          
          echo "âœ… Infrastructure destroyed successfully"

      - name: âŒ Manual approval required
        if: github.event.inputs.auto_approve != 'true'
        run: |
          echo "âŒ Manual approval required for destroy operation"
          echo "ğŸ’¡ Re-run with auto_approve=true to proceed"
          exit 1

  # Job para notificaÃ§Ãµes
  notify:
    name: ğŸ“¬ Deployment Notifications
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: always() && needs.terraform-apply.result != 'skipped'
    
    steps:
      - name: âœ… Success notification
        if: needs.terraform-apply.result == 'success'
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸš€ Environment: ${{ needs.terraform-apply.outputs.environment || 'N/A' }}"
          echo "ğŸ”— Check deployment summary above for details"

      - name: âŒ Failure notification
        if: needs.terraform-apply.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ› ï¸ Manual intervention may be required"
          
          # Aqui vocÃª pode adicionar integraÃ§Ã£o com Slack/Teams se necessÃ¡rio
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸš¨ Terraform deploy failed for DevOps UNISATC A3"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“Š Final Summary
        run: |
          echo "## ğŸ“Š Deployment Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| Plan | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| Apply | ${{ needs.terraform-apply.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run**: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY